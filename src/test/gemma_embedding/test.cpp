#include <iostream>
#include <cmath>
#include "utils/utils.hpp"
#include "utils/vm_args.hpp"
#include "AutoEmbeddingModel/auto_embedding_model.hpp"
#include "model_list.hpp"
#include "AutoEmbeddingModel/modeling_gemma_embedding.hpp"
#include "metrices.hpp"

static float reference[] = {
    -6.835938e-02,  9.423828e-02,   4.516602e-02,   3.015137e-02,   -6.347656e-02,  -1.531982e-02,  -3.564453e-02,  -1.507568e-02,  2.282715e-02,   4.003906e-02,   8.117676e-03,   -3.540039e-02,  9.399414e-03,   2.770996e-02,   7.110596e-03,   1.202393e-02,
    -9.521484e-03,  -2.929688e-02,  -5.584717e-03,  1.678467e-03,   -7.666016e-02,  -4.345703e-02,  -7.202148e-03,  -1.531982e-02,  2.087402e-02,   -2.111816e-02,  6.494141e-02,   1.794434e-02,   3.930664e-02,   5.615234e-03,   2.722168e-02,   -3.930664e-02,
    -2.209473e-02,  -1.977539e-02,  3.149414e-02,   -2.795410e-02,  4.321289e-02,   -4.052734e-02,  -2.331543e-02,  1.214600e-02,   -2.517700e-03,  3.039551e-02,   1.574707e-02,   4.589844e-02,   -5.340576e-03,  -1.782227e-02,  1.647949e-02,   -3.015137e-02,
    3.063965e-02,   5.273438e-02,   -1.519775e-02,  2.673340e-02,   -9.094238e-03,  -5.761719e-02,  -1.599121e-02,  -1.086426e-02,  1.660156e-02,   2.893066e-02,   1.489258e-02,   2.697754e-02,   -2.563477e-02,  -2.832031e-02,  -9.472656e-02,  -1.141357e-02,
    2.648926e-02,   -2.404785e-02,  1.464844e-02,   -1.586914e-02,  5.297852e-02,   5.688477e-02,   1.043701e-02,   4.565430e-02,   1.757812e-02,   -8.007812e-02,  1.035156e-01,   -1.235352e-01,  4.760742e-02,   -1.068115e-02,  -4.101562e-02,  6.591797e-02,
    -5.786133e-02,  2.233887e-02,   -6.347656e-02,  3.295898e-03,   6.408691e-03,   3.112793e-02,   5.419922e-02,   -1.190186e-02,  -1.239014e-02,  5.932617e-02,   -4.956055e-02,  3.686523e-02,   1.083374e-03,   -6.982422e-02,  5.981445e-03,   -4.333496e-03,
    -1.319885e-03,  9.912109e-02,   4.663086e-02,   1.477051e-02,   5.957031e-02,   -3.369141e-02,  3.173828e-02,   7.470703e-02,   -3.067017e-03,  -1.123047e-02,  -1.519775e-02,  -3.247070e-02,  2.380371e-02,   -1.621246e-04,  -1.878738e-04,  -4.150391e-02,
    -6.445312e-02,  1.000977e-01,   6.689453e-02,   -3.466797e-02,  -2.539062e-02,  5.249023e-02,   1.647949e-02,   1.831055e-02,   3.198242e-02,   1.940918e-02,   9.667969e-02,   3.616333e-03,   -2.148438e-02,  -5.395508e-02,  4.058838e-03,   -1.574707e-02,
    -5.834961e-02,  -4.150391e-03,  -7.232666e-03,  7.031250e-02,   1.336670e-02,   -1.777649e-03,  4.882812e-02,   -5.493164e-03,  1.989746e-02,   1.312256e-02,   -2.026367e-02,  -2.612305e-02,  -5.126953e-03,  -3.930664e-02,  -9.460449e-03,  2.795410e-02,
    1.708984e-02,   1.916504e-02,   -9.460449e-03,  1.562500e-02,   -6.030273e-02,  2.050781e-02,   -2.294922e-02,  4.663086e-02,   -5.761719e-02,  3.692627e-03,   7.128906e-02,   6.195068e-03,   8.154297e-02,   3.784180e-02,   -1.599121e-02,  -7.031250e-02,
    2.746582e-02,   -3.808594e-02,  1.757812e-02,   3.808594e-02,   -6.079102e-02,  4.223633e-02,   -1.139641e-04,  4.150391e-03,   -2.661133e-02,  -2.453613e-02,  -2.551270e-02,  -9.948730e-03,  -3.173828e-02,  -7.476807e-03,  -4.541016e-02,  -7.666016e-02,
    1.177979e-02,   -6.835938e-02,  3.515625e-02,   1.293945e-02,   -1.916504e-02,  3.936768e-03,   1.336670e-02,   1.104736e-02,   9.155273e-03,   7.812500e-03,   4.089355e-03,   5.889893e-03,   -1.043701e-02,  -6.640625e-02,  4.663086e-02,   1.403809e-02,
    -3.564453e-02,  -1.263428e-02,  -4.077148e-02,  -4.370117e-02,  4.248047e-02,   -3.112793e-02,  -4.565430e-02,  -3.466797e-02,  2.380371e-02,   -7.031250e-02,  2.734375e-02,   -2.209473e-02,  -4.101562e-02,  3.417969e-02,   -6.127930e-02,  3.662109e-02,
    -2.124023e-02,  -5.249023e-03,  2.478027e-02,   -1.116943e-02,  -9.887695e-03,  -2.514648e-02,  1.672363e-02,   -3.637695e-02,  -1.123047e-02,  9.704590e-03,   2.087402e-02,   -8.422852e-03,  4.833984e-02,   -6.689453e-02,  -3.814697e-04,  1.611328e-02,
    -3.417969e-02,  -3.564453e-02,  4.687500e-02,   1.000977e-02,   7.080078e-02,   1.928711e-02,   -3.637695e-02,  -9.582520e-03,  6.134033e-03,   4.394531e-02,   -3.564453e-02,  2.148438e-02,   -3.372192e-03,  -3.295898e-02,  -3.417969e-02,  5.615234e-02,
    -2.746582e-02,  7.141113e-03,   4.663086e-02,   4.956055e-02,   2.246094e-02,   -5.664062e-02,  1.855469e-02,   -1.953125e-02,  2.307129e-02,   -3.088379e-02,  -1.867676e-02,  2.819824e-02,   -3.564453e-02,  1.330566e-02,   -1.904297e-02,  1.385498e-02,
    -8.972168e-03,  2.075195e-02,   -5.279541e-03,  -5.590820e-02,  -4.577637e-03,  1.208496e-02,   -4.302979e-03,  -4.882812e-04,  -2.166748e-03,  4.345703e-02,   -1.586914e-02,  -5.493164e-02,  -8.398438e-02,  -8.496094e-02,  4.125977e-02,   -9.948730e-03,
    3.173828e-02,   4.223633e-02,   -3.707886e-03,  7.324219e-02,   -2.722168e-02,  2.966309e-02,   -2.343750e-02,  1.342773e-02,   -1.708984e-02,  -4.455566e-03,  -1.416016e-02,  -2.294922e-02,  1.312256e-02,   2.758789e-02,   4.455566e-03,   7.720947e-03,
    -4.296875e-02,  -1.556396e-02,  -4.003906e-02,  1.324463e-02,   -1.507568e-02,  8.911133e-03,   6.127930e-02,   4.980469e-02,   -1.232910e-02,  -3.906250e-02,  -1.000977e-02,  -4.370117e-02,  -3.955078e-02,  -8.117676e-03,  -8.911133e-03,  6.469727e-03,
    2.294922e-02,   9.765625e-03,   -4.052734e-02,  2.294922e-02,   -2.227783e-03,  -3.128052e-03,  -1.379395e-02,  -3.829956e-03,  -8.422852e-03,  3.906250e-02,   -1.792908e-03,  4.199219e-02,   2.734375e-02,   1.770020e-02,   1.324463e-02,   3.808594e-02,
    2.819824e-02,   -2.307129e-02,  1.843262e-02,   -5.908203e-02,  -5.126953e-02,  2.160645e-02,   4.516602e-03,   -1.263428e-02,  -8.178711e-03,  1.733398e-02,   9.765625e-03,   2.990723e-02,   6.225586e-03,   1.782227e-02,   -9.765625e-03,  -6.030273e-02,
    2.001953e-02,   5.078125e-02,   2.761841e-03,   2.270508e-02,   -1.019287e-02,  2.038574e-02,   2.624512e-02,   -8.850098e-03,  -4.394531e-03,  -2.563477e-02,  2.014160e-02,   -1.007080e-02,  -1.123047e-02,  -3.540039e-02,  -1.855469e-02,  -1.879883e-02,
    -7.720947e-03,  4.394531e-02,   3.955078e-02,   1.855469e-02,   -4.394531e-02,  6.176758e-02,   -8.239746e-03,  1.696777e-02,   -6.347656e-02,  -7.373047e-02,  2.026367e-02,   -3.808594e-02,  -3.588867e-02,  1.708984e-02,   3.417969e-02,   7.095337e-04,
    4.370117e-02,   4.711914e-02,   -2.502441e-02,  -2.575684e-02,  -1.080322e-02,  -6.250000e-02,  1.416016e-02,   -1.745605e-02,  3.955078e-02,   -1.556396e-03,  -3.509521e-03,  -7.226562e-02,  -8.105469e-02,  -6.195068e-03,  -1.074219e-01,  -1.544189e-02,
    1.441956e-03,   -1.350403e-03,  1.518250e-03,   -3.829956e-03,  -7.324219e-02,  -1.306152e-02,  4.199219e-02,   -1.904297e-02,  1.147461e-02,   1.562500e-02,   -3.808594e-02,  -3.829956e-03,  3.479004e-03,   -8.666992e-03,  -2.392578e-02,  1.040039e-01,
    -1.818848e-02,  -2.716064e-03,  3.784180e-02,   -3.466797e-02,  2.319336e-03,   2.148438e-02,   -3.616333e-03,  2.380371e-02,   -1.354980e-02,  -1.594543e-03,  5.950928e-03,   -4.052734e-02,  3.955078e-02,   -5.590820e-02,  -2.709961e-02,  1.879883e-02,
    1.965332e-02,   -1.635742e-02,  5.737305e-03,   -4.760742e-02,  -2.282715e-02,  5.273438e-02,   -6.250000e-02,  -6.884766e-02,  -3.112793e-02,  5.836487e-04,   -8.911133e-03,  3.857422e-02,   5.416870e-04,   -1.019287e-02,  5.468750e-02,   2.001953e-02,
    5.883789e-02,   3.320312e-02,   3.442383e-02,   1.019287e-02,   -4.882812e-02,  -8.300781e-03,  2.502441e-02,   7.873535e-03,   3.564453e-02,   3.466797e-02,   3.271484e-02,   3.637695e-02,   5.151367e-02,   -1.611328e-02,  -1.263428e-02,  2.160645e-02,
    -3.588867e-02,  2.172852e-02,   9.216309e-03,   -5.981445e-02,  -2.807617e-03,  3.833008e-02,   -8.605957e-03,  -9.130859e-02,  -3.417969e-02,  -1.928711e-02,  -6.884766e-02,  -5.706787e-03,  2.685547e-03,   8.178711e-03,   -4.614258e-02,  -4.638672e-02,
    -4.125977e-02,  -1.998901e-03,  -1.684570e-02,  -4.028320e-02,  6.256104e-03,   -1.660156e-02,  -8.728027e-03,  2.307129e-02,   8.349609e-02,   -2.075195e-02,  -1.495361e-02,  5.541992e-02,   1.855469e-02,   -4.931641e-02,  -9.179688e-02,  4.809570e-02,
    -3.393555e-02,  1.409912e-02,   -3.686523e-02,  -6.286621e-03,  -5.834961e-02,  -9.948730e-03,  -4.516602e-02,  3.125000e-02,   -5.554199e-03,  1.043701e-02,   9.716797e-02,   2.624512e-02,   1.611328e-02,   2.331543e-02,   1.287842e-02,   5.468750e-02,
    -2.734375e-02,  1.574707e-02,   -3.735352e-02,  -1.531982e-02,  2.404785e-02,   -4.003906e-02,  5.639648e-02,   1.196289e-02,   -4.760742e-02,  -1.013184e-02,  3.369141e-02,   -1.196289e-02,  -1.104736e-02,  2.197266e-02,   -1.196289e-02,  2.600098e-02,
    5.957031e-02,   -3.723145e-03,  4.174805e-02,   -5.065918e-03,  -2.258301e-02,  6.298828e-02,   9.765625e-03,   -2.197266e-02,  8.105469e-02,   -4.541016e-02,  3.881836e-02,   1.556396e-02,   -2.746582e-02,  -6.439209e-03,  2.148438e-02,   -2.087402e-02,
    -2.099609e-02,  -2.416992e-02,  -4.931641e-02,  2.044678e-03,   -5.218506e-03,  2.288818e-04,   -4.223633e-02,  1.043701e-02,   -9.155273e-03,  1.202393e-02,   -1.106262e-03,  -1.458740e-02,  1.190186e-02,   -3.967285e-03,  -4.223633e-02,  -1.623535e-02,
    7.128906e-02,   -1.806641e-02,  2.600098e-02,   -3.344727e-02,  -3.369141e-02,  -3.112793e-02,  3.857422e-02,   -1.251221e-02,  -4.541016e-02,  1.458740e-02,   -7.171631e-03,  -5.224609e-02,  -2.551270e-02,  3.799438e-03,   6.072998e-03,   7.226562e-02,
    1.945496e-03,   3.936768e-03,   -1.141357e-02,  -2.856445e-02,  1.441956e-03,   3.930664e-02,   3.637695e-02,   2.636719e-02,   -4.076958e-05,  1.025391e-02,   3.637695e-02,   3.515625e-02,   -2.365112e-03,  2.770996e-02,   6.675720e-04,   5.664062e-02,
    -1.806641e-02,  1.379395e-02,   7.934570e-03,   1.342773e-02,   -4.516602e-02,  2.966309e-02,   8.911133e-03,   -2.111816e-02,  4.736328e-02,   2.441406e-02,   -9.521484e-03,  1.611328e-02,   -1.013184e-02,  3.271484e-02,   5.615234e-02,   1.342773e-02,
    1.586914e-02,   1.562500e-02,   3.417969e-02,   1.599121e-02,   9.619141e-02,   7.781982e-03,   4.980469e-02,   4.321289e-02,   -4.467773e-02,  2.270508e-02,   4.443359e-02,   -2.673340e-02,  1.489258e-02,   -4.809570e-02,  2.929688e-02,   -5.566406e-02,
    1.782227e-02,   -1.391602e-02,  4.882812e-02,   1.000977e-02,   3.491211e-02,   -8.850098e-03,  2.502441e-02,   3.860474e-03,   6.835938e-02,   -2.929688e-02,  1.074219e-02,   -7.958984e-02,  1.696777e-02,   -9.948730e-03,  4.101562e-02,   5.859375e-02,
    -3.613281e-02,  5.004883e-02,   2.978516e-02,   -8.850098e-03,  4.638672e-02,   4.711914e-02,   3.710938e-02,   -2.822876e-03,  -2.075195e-02,  -9.277344e-03,  -1.416016e-02,  -1.989746e-02,  1.470947e-02,   8.935547e-02,   -1.354980e-02,  -4.516602e-02,
    -7.705688e-04,  1.989746e-02,   4.302979e-03,   1.818848e-02,   7.720947e-03,   -1.586914e-02,  1.220703e-02,   5.981445e-02,   -1.171875e-02,  -6.933594e-02,  1.879883e-02,   2.197266e-02,   5.493164e-02,   6.933594e-02,   -6.030273e-02,  -3.906250e-02,
    1.037598e-02,   -3.515625e-02,  2.758789e-02,   -1.556396e-02,  3.735352e-02,   -4.931641e-02,  3.417969e-02,   5.065918e-03,   -4.223633e-02,  -8.361816e-03,  8.666992e-03,   -2.355957e-02,  1.190186e-02,   -1.684570e-02,  1.686096e-03,   1.892090e-02,
    5.371094e-02,   -5.102539e-02,  -1.611328e-02,  -1.136780e-03,  -9.298325e-05,  -3.515625e-02,  6.689453e-02,   1.440430e-02,   -8.056641e-03,  2.905273e-02,   -7.873535e-03,  5.859375e-02,   7.128906e-02,   -4.174805e-02,  7.177734e-02,   8.728027e-03,
    4.418945e-02,   7.128906e-02,   6.079102e-02,   -3.088379e-02,  3.198242e-02,   3.222656e-02,   3.063965e-02,   2.856445e-02,   3.735352e-02,   -4.907227e-02,  -3.955078e-02,  -8.056641e-03,  1.708984e-02,   1.989746e-02,   3.601074e-03,   -5.932617e-02,
    3.564453e-02,   1.251221e-02,   4.296875e-02,   -4.882812e-02,  3.857422e-02,   2.355957e-02,   1.147461e-02,   -8.154297e-02,  1.434326e-02,   4.296875e-02,   -3.417969e-02,  -4.730225e-03,  3.015137e-02,   -1.495361e-02,  7.812500e-02,   1.055908e-02,
    2.551270e-02,   -3.222656e-02,  -3.344727e-02,  3.881836e-02,   -5.639648e-02,  -2.868652e-02,  2.282715e-02,   -2.990723e-02,  -4.003906e-02,  -3.881836e-02,  5.517578e-02,   -2.990723e-02,  -2.758789e-02,  2.709961e-02,   -9.887695e-03,  -2.746582e-02,
    -3.637695e-02,  -1.239014e-02,  4.638672e-02,   -7.519531e-02,  -2.709961e-02,  7.781982e-03,   3.784180e-02,   3.204346e-04,   -3.320312e-02,  -6.298828e-02,  -4.956055e-02,  6.225586e-02,   -1.379395e-02,  4.174805e-02,   3.588867e-02,   5.554199e-03,
    4.077148e-02,   1.806641e-02,   1.843262e-02,   -2.661133e-02,  7.446289e-03,   3.768921e-03,   5.566406e-02,   -4.687500e-02,  -4.174805e-02,  1.531982e-02,   9.765625e-03,   2.343750e-02,   2.905273e-02,   2.246094e-02,   2.160645e-02,   5.859375e-03
};
// Model-specific factory function for Gemma3 Text family only
inline std::pair<std::string, std::unique_ptr<AutoEmbeddingModel>> get_gemma_embedding_model(const std::string& model_tag, xrt::device* npu_device_inst) {
    static std::unordered_set<std::string> gemma_embedding_Tags = {
        "embed-gemma", "embed-gemma:300m"
    };

    std::unique_ptr<AutoEmbeddingModel> auto_embedding_engine = nullptr;
    std::string new_model_tag = model_tag;
    
    if (gemma_embedding_Tags.count(model_tag))
        auto_embedding_engine = std::make_unique<Gemma_Embedding>(npu_device_inst);
    else {
        new_model_tag = "embed-gemma:300m"; // Default to text-only model
        auto_embedding_engine = std::make_unique<Gemma_Embedding>(npu_device_inst);
    }
  
    return std::make_pair(new_model_tag, std::move(auto_embedding_engine));
}

int main(int argc, char* argv[]) {
    arg_utils::po::options_description desc("Allowed options");
    arg_utils::po::variables_map vm;
    desc.add_options()("model,m", arg_utils::po::value<std::string>()->required(), "Model file");
    desc.add_options()("Short,s", arg_utils::po::value<bool>()->default_value(true), "Short Prompt");
    desc.add_options()("Preemption,p", arg_utils::po::value<bool>()->default_value(false), "Preemption");
    
    arg_utils::po::store(arg_utils::po::parse_command_line(argc, argv, desc), vm);

    std::string tag = vm["model"].as<std::string>();
    bool short_prompt = vm["Short"].as<bool>();
    bool preemption = vm["Preemption"].as<bool>();

    std::cout << "Model: " << tag << std::endl;
    std::string exe_dir = utils::get_executable_directory();
    std::string model_dir = utils::get_models_directory();
    std::string model_list_path = exe_dir + "/model_list.json";
    model_list model_list(model_list_path, model_dir);
   
    header_print("info", "Initializing embedding model...");
    std::string model_path = model_list.get_model_path(tag);
    nlohmann::json model_info = model_list.get_model_info(tag);
    std::cout << "Model path: " << model_path << std::endl;
    std::cout << "Model info: " << model_info.dump() << std::endl;

    auto npu_device_global = xrt::device(0);

    // Use model-specific factory
    std::unique_ptr<AutoEmbeddingModel> embedding = std::make_unique<Gemma_Embedding>(&npu_device_global);
    model_path = model_list.get_model_path(tag);
    model_info = model_list.get_model_info(tag);

    embedding->load_model(model_path, model_info, preemption);

    std::string text = "Alice's Adventures in Wonderland ALICE'S ADVENTURES IN WONDERLAND Lewis Carroll THE MILLENNIUM FULCRUM EDITION 3.0 CHAPTER I Down the Rabbit-HoleAlice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do:  once or twice she had peeped into the book her sister was reading, but it had no pictures or conversations in it, and what is the use of a book,'thought Alice without pictures or conversation?' So she was considering in her own mind (as well as she could, for the hot day made her feel very sleepy and stupid), whether the pleasure of making a daisy-chain would be worth the trouble of getting up and picking the daisies, when suddenly a White Rabbit with pink eyes ran close by her. There was nothing so VERY remarkable in that; nor did Alice think it so VERY much out of the way to hear the Rabbit say to itself, `Oh dear!  Oh dear!  I shall be late!'";

    time_utils::time_point start_time = time_utils::now();
    auto y = embedding->embed(text, task_query);
    buffer<bf16> y_bf16(y.size());
    for (int i = 0; i < y.size(); i++){
        y_bf16[i] = (bf16)y[i];
    }
    time_utils::time_point end_time = time_utils::now();
    std::cout << "Time: " << time_utils::duration_ms(start_time, end_time).first << "ms" << std::endl;
    utils::print_matrix(y_bf16, 128);

    buffer<bf16> ref_bf16 = buffer<bf16>(y_bf16.size());

    for (int i = 0; i < y_bf16.size(); i++){
        ref_bf16[i] = (bf16)reference[i];
    }

    print_error_metrics(get_error_metrics(y_bf16, ref_bf16));

    return 0;
}