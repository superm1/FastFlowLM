name: Ubuntu 26.04 Build

on:
  push:
    branches:
      - linux
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - ubuntu_version: "24.04"
            container_tag: "ubuntu24.04"
          - ubuntu_version: "26.04"
            container_tag: "ubuntu26.04"
    container:
      image: ghcr.io/superm1/fastflowlm/build-environment:${{ matrix.container_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Get short SHA
        id: short_sha
        run: echo "sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache CMake build directory
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/src/build
          key: cmake-cache-${{ runner.os }}-${{ steps.short_sha.outputs.sha }}
          restore-keys: |
            cmake-cache-${{ runner.os }}-

      - name: Upgrade Rust toolchain (24.04)
        if: ${{ matrix.ubuntu_version == '24.04' }}
        run: |
          apt-get update
          apt-get install -y --no-install-recommends curl ca-certificates
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | \
            sh -s -- -y --profile minimal --default-toolchain stable
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          rustc --version

      - name: Configure CMake
        working-directory: ${{ github.workspace }}/src
        run: |
          rm -rf build
          mkdir -p build
          cd build
          cmake .. \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=./artifact

      - name: Build project
        working-directory: ${{ github.workspace }}/src/build
        run: cmake --build .

      - name: Install to artifact directory
        working-directory: ${{ github.workspace }}/src/build
        run: ninja install

      - name: Flatten artifact structure and copy libraries
        working-directory: ${{ github.workspace }}/src
        run: |
          mkdir -p build/artifact
          echo "Moving binary to artifact root..."
          mv build/artifact/bin/flm build/artifact/
          rm -rf build/artifact/bin build/artifact/share build/artifact/include

          # XRT and Boost
          echo "Copying XRT and boost libraries..."
          find /usr/lib/x86_64-linux-gnu/ \
            \( -name "libxrt*.so*" -o -name "libboost_program_options*.so*" \) \
            \( -type f -o -type l \) \
            -exec cp -aP {} build/artifact/ \; 2>/dev/null || true

          # NPU libraries
          echo "Copying NPU libraries from lib:"
          find lib -name "*.so" \( -type f -o -type l \) \
            -exec cp -aP {} build/artifact/ \; 2>/dev/null || echo "No NPU libraries found"

          # Copy model list
          cp model_list.json build/artifact/

          # Cleaning up rpath and permissions
          echo "Setting rpath on flm binary:"
          patchelf --set-rpath '$ORIGIN' build/artifact/flm
          patchelf --print-rpath build/artifact/flm
          echo "Setting RPATH on all .so files:"
          find . -name "*.so*" -type f \
            -exec patchelf --set-rpath '$ORIGIN' {} \;
          find . -name "*.so*" -type f \
            -exec chmod -x {} \;

          echo "=== artifact contents ==="
          ls -lah build/artifact/

      - name: Verify and finalize artifact
        working-directory: ${{ github.workspace }}/src/build/artifact
        run: |
          echo "Testing flm runs:"
          ./flm list

          # Cleanup and finalize
          find . -name "*.a" -type f -delete

          echo "=== Final artifact contents ==="
          ls -lah

      - name: Package artifact
        working-directory: ${{ github.workspace }}/src/build
        run: |
          tar -czf flm-ubuntu${{ matrix.ubuntu_version }}-${{ steps.short_sha.outputs.sha }}.tar.gz -C artifact .
          ls -lah flm-ubuntu${{ matrix.ubuntu_version }}-${{ steps.short_sha.outputs.sha }}.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flm-ubuntu${{ matrix.ubuntu_version }}-${{ steps.short_sha.outputs.sha }}
          path: ${{ github.workspace }}/src/build/flm-ubuntu${{ matrix.ubuntu_version }}-${{ steps.short_sha.outputs.sha }}.tar.gz
          if-no-files-found: error

  package-deb:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - ubuntu_version: "24.04"
            container_tag: "ubuntu24.04"
            deb_codename: "noble"
          - ubuntu_version: "26.04"
            container_tag: "ubuntu26.04"
            deb_codename: "resolute"
    container:
      image: ghcr.io/superm1/fastflowlm/build-environment:${{ matrix.container_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      DEB_VERSION: 0.0.0+${{ github.sha }}
    steps:
      - name: Get short SHA
        id: short_sha
        run: echo "sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Create Debian packaging metadata
        working-directory: ${{ github.workspace }}
        run: |
          sed -e "s|@@DEB_VERSION@@|${DEB_VERSION}|g" \
              -e "s|@@DEB_CODENAME@@|${{ matrix.deb_codename }}|g" \
              -e "s|@@DEB_DATE@@|$(date -R)|g" \
              debian/changelog.in > debian/changelog

          chmod +x debian/rules

      - name: Upgrade Rust toolchain (24.04)
        if: ${{ matrix.ubuntu_version == '24.04' }}
        run: |
          apt-get update
          apt-get install -y --no-install-recommends curl ca-certificates
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | \
            sh -s -- -y --profile minimal --default-toolchain stable
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          rustc --version

      - name: Build Debian package
        working-directory: ${{ github.workspace }}
        env:
          DEBEMAIL: noreply@example.com
          DEBFULLNAME: fastflowlm
        run: |
          dpkg-buildpackage -b -us -uc
          mv ../fastflowlm_${DEB_VERSION}_amd64.deb ./fastflowlm_${DEB_VERSION}_ubuntu${{ matrix.ubuntu_version }}_amd64.deb
          ls -lah ./fastflowlm_${DEB_VERSION}_ubuntu${{ matrix.ubuntu_version }}_amd64.deb

      - name: Upload Debian package artifact
        uses: actions/upload-artifact@v4
        with:
          name: flm-ubuntu${{ matrix.ubuntu_version }}-${{ steps.short_sha.outputs.sha }}-deb
          path: ./fastflowlm_${{ env.DEB_VERSION }}_ubuntu${{ matrix.ubuntu_version }}_amd64.deb
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: package-deb
    if: github.event_name == 'push'
    steps:
      - name: Get short SHA
        id: short_sha
        run: echo "sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Download all deb artifacts
        uses: actions/download-artifact@v4
        with:
          path: debs
          pattern: '*-deb'

      - name: Create or update release
        uses: softprops/action-gh-release@v1
        with:
          files: debs/*/*.deb
          tag_name: build-${{ steps.short_sha.outputs.sha }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}